<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Knowledge Group Type Selector</title>

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />

  <!-- Bootstrap Table CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-table@1.21.2/dist/bootstrap-table.min.css" rel="stylesheet" />

  <!-- Custom CSS for preformatted text -->
  <style>
    .preformatted {
      white-space: pre;
    }
  </style>
</head>
<body>

  <div class="container mt-4">

    <!-- Select Group Type -->
    <div class="card mb-4 shadow-sm">
      <div class="card-header">
        <h5>GEN AI</h5>
      </div>
      <div class="card-body">
        <form id="groupTypeForm" class="row g-3">
          <!-- Group Type Select -->
          <div class="col-12">
            <label for="groupTypeSelect" class="form-label">Select Group Type</label>
            <select class="form-select" id="groupTypeSelect" name="groupType" required>
              <option value="" disabled selected>Select a Group Type</option>
            </select>
          </div>

          <!-- Question input -->
          <div class="col-12">
            <label for="questionInput" class="form-label">Question</label>
            <input type="text" class="form-control" id="questionInput" name="question"
              placeholder="Enter your question" />
          </div>

          <!-- Submit button placed below the question -->
          <div class="col-12">
            <button type="submit" class="btn btn-primary w-100">Generate</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Blank Answer Frame Card -->
    <div class="card mb-4 shadow-sm">
      <div class="card-header bg-secondary text-white">
        <h5 class="mb-0">Answer</h5>
      </div>
      <div class="card-body" id="answerFrame" style="min-height: 150px;">
        <!-- Answer content will appear here -->
      </div>
    </div>

    <!-- Group Type Info -->
    <div id="groupTypeInfo" class="card mb-4 shadow-sm" style="display:none;">
      <div class="card-header bg-primary text-white">
        <h5 class="mb-0">Knowledge Group Type Details</h5>
      </div>
      <div class="card-body" id="groupTypeDetails"></div>
    </div>

    <!-- Knowledge Table -->
    <div id="knowledgeSection" style="display:none;">
      <table id="knowledgeTable" class="table table-striped" data-search="true" data-pagination="true"
        data-page-size="5" data-show-columns="true" data-toggle="table">
        <thead>
          <tr>
            <th data-field="index" data-formatter="indexFormatter" data-width="50" data-align="center">#</th>
            <th data-field="knowledgeName" data-sortable="true">Knowledge Name</th>
            <th data-field="knowledge" data-sortable="true">Knowledge</th>
            <th data-field="createdDateTime" data-sortable="true">Created</th>
            <th data-field="lastEditDateTime" data-sortable="true">Last Edited</th>
          </tr>
        </thead>
      </table>
    </div>

  </div>

  <!-- JS Dependencies -->
  <script src="https://cdn.jsdelivr.net/npm/jquery/dist/jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <!-- Bootstrap Table JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap-table@1.21.2/dist/bootstrap-table.min.js"></script>

  <script>
    const groupTypeDataMap = {};

    // Index formatter for Bootstrap Table
    function indexFormatter(value, row, index) {
      return index + 1;
    }

    // Format ISO datetime to local string
    function formatDateTime(dateString) {
      if (!dateString) return '';
      return new Date(dateString).toLocaleString();
    }

    // Escape HTML text
    function escapeHtml(text) {
      return $('<div>').text(text).html();
    }

    // Load group types from server
    function loadGroupTypes() {
      return $.ajax({
        url: '/api/knowledgeGroupType',
        method: 'GET'
      }).done(data => {
        const $select = $('#groupTypeSelect');
        data.forEach(gt => {
          groupTypeDataMap[gt.id] = gt;
          $select.append(new Option(gt.groupName, gt.id));
        });
      }).fail(() => alert('Failed to load Knowledge Group Types.'));
    }

    // Render group type info card
    function renderGroupTypeInfo(groupType) {
      const html = `
      <dl class="row">
        <dt class="col-sm-3">Knowledge Group Name</dt>
        <dd class="col-sm-9">${escapeHtml(groupType.groupName)}</dd>
        <dt class="col-sm-3">System Instruction</dt>
        <dd class="col-sm-9"><div class="preformatted">${escapeHtml(groupType.systemInstruction || '')}</div></dd>
        <dt class="col-sm-3">Created</dt>
        <dd class="col-sm-9">${formatDateTime(groupType.createdDateTime)}</dd>
        <dt class="col-sm-3">Last Edited</dt>
        <dd class="col-sm-9">${formatDateTime(groupType.lastEditDateTime)}</dd>
      </dl>`;
      $('#groupTypeDetails').html(html);
      $('#groupTypeInfo').show();
    }

    // Prepare knowledge data for Bootstrap Table
    function prepareKnowledgeData(knowledgeList) {
      return knowledgeList.map(k => ({
        ...k,
        createdDateTime: formatDateTime(k.createdDateTime),
        lastEditDateTime: formatDateTime(k.lastEditDateTime),
        knowledgeName: escapeHtml(k.knowledgeName),
        knowledge: `<div class="preformatted">${escapeHtml(k.knowledge || '')}</div>`
      }));
    }

    // Load knowledge entries by group type id
    function loadKnowledgeByGroupType(groupTypeId) {
      return $.ajax({
        url: `/api/knowledge/groupType/${groupTypeId}`,
        method: 'GET'
      });
    }

    $(document).ready(() => {
      loadGroupTypes();

      $('#groupTypeForm').on('submit', e => {
        e.preventDefault();
        const selectedId = $('#groupTypeSelect').val();
        if (!selectedId) {
          alert('Please select a group type.');
          return;
        }

        const groupType = groupTypeDataMap[selectedId];
        renderGroupTypeInfo(groupType);

        loadKnowledgeByGroupType(selectedId)
          .done(knowledgeList => {
            $('#knowledgeSection').show();

            if (knowledgeList.length === 0) {
              $('#knowledgeTable').bootstrapTable('load', []);
              alert('No knowledge entries found for this group type.');
              return;
            }

            const data = prepareKnowledgeData(knowledgeList);
            $('#knowledgeTable').bootstrapTable('load', data);
          })
          .fail(() => {
            alert('Failed to load Knowledge entries.');
            $('#knowledgeSection').hide();
          });
      });

      // Initialize Bootstrap Table with empty data
      $('#knowledgeTable').bootstrapTable({ data: [] });
    });
  </script>

</body>
</html>
